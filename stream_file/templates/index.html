<html lang="en">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>stream storage</title>
<link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
</head>
<body data-current-path="{{ path }}">
{% block body %}

<header>
     <h1>üìÇ Stream Storage</h1>
    <button class="btn" onclick="openFileDialog()">Upload File</button>
    <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">
    <div class="toolbar">
        <select id="sortSelect" class="btn" onchange="sortItems(this.value)">
            <option value="name">Name (A-Z)</option>
            <option value="date">Date Modified</option>
        </select>

        <button class="btn active" onclick="setView('list')" id="btnList" title="List View">
            ‚ò∞
        </button>
        <button class="btn" onclick="setView('grid')" id="btnGrid" title="Grid View">
            ‚äû
        </button>
    </div>
</header>

<!-- ‚úÖ Upload Progress Container -->
<div id="uploadContainer" class="upload-container" style="display:none;">
    <div class="upload-box">
        <span id="uploadText">Uploading... 0%</span>
        <div class="progress-bar">
            <div id="progressFill"></div>
        </div>
    </div>
</div>
<div class="drive-container">
        {% for drive in drives %}
            <a href="/dir/{{ drive }}" class="drive-card active" onclick="selectDrive(event, this)">
                <div class="drive-icon">üíø</div>
                <div class="drive-info">
                    <span class="drive-name">Local Disk ({{ drive }})</span>
                    <span class="drive-label">System</span>
                </div>
            </a>
        {% endfor %}
</div>

<nav class="breadcrumbs">
    {% if path %}
        {% set path_=path.split('/') %}
        {% for i in  path_ %}

            <a href='/dir/{{ "/".join(path_[:loop.index]) }}'>{{ path_[:loop.index][loop.index0] }}</a>
            /
        {% endfor %}

    {% endif %}
</nav>

{%if files%}
  {% for key,dict in files.items()%}
    <div class="file-section">
       
                

                {%if key=="dir"%}
                            <h3 class="section-title">{{key.uppercase}}</h3>
                            <ul class="file-list" id="dirList">
                        {% for di in dict %}
                            {% for k,v in di.items() %}
                                {% if k=='path' %}
                                    {% set dir_=v.split('/')[-1:]|join('') %}
                                        <li class="list-item" data-name="{{ dir_ }}" data-timestamp="1700100000">
                                                        <div class="item-info">
                                                            <div class="item-icon">üìÅ</div>
                                                                <div class="item-details">
                                                                    <span class="item-name">{{ dir_ }}</span>
                                           

                                                                             {% if di.get('time_mod') %}
                                                                                        <span class="item-meta">{{ di.get('time_mod') }}</span>
                                                                             {% endif %}
                                                                             {% if not di.get('listable', di.get('perm', {}).get('r', False)) %}
                                                                                        <span class="item-meta">Access denied</span>
                                                                             {% endif %}
                                                                </div>
                                                        </div>
                                                    {% if di.get('listable', di.get('perm', {}).get('r', False)) %}
                                                        <a href="/dir/{{ v }}" class="action-link">Open</a>
                                                    {% else %}
                                                        <span class="action-link">No Access</span>
                                                    {% endif %}
                                               
                                
                                        </li>
                                         {% endif %}
                            {% endfor %}
                        {% endfor %}

                                        
            </ul>
    </div>

    {% elif key=='files' %}


    <div class="file-section">
    <h3 class="section-title">{{key.uppercase}}</h3>
    <ul class="file-list" id="fileList">
                            {% for dit in dict %}
                                {% for k,v in dit.items() %}
                                    {% if k=='path' %}
                                        {% set file_=v.split('/')[-1:]|join('') %}
                                        <li class="list-item" data-name="{{ file_ }}" data-timestamp="1700100000">
                                                <div class="item-info">
                                                    <div class="item-icon">üìÉ</div>
                                                        <div class="item-details">
                                                            <span class="item-name">{{ file_ }}</span>
                                                        {% if dit.get('time_mod') %}
                                                                        <span class="item-meta">
                                                                                {{ dit.get('time_mod') }}
                                                                            </span>
                                                        {%endif%}
                                                        </div>
                                                </div>
                                                            {% if dit.get('perm', {}).get('r', False) %}
                                                                <a href="/file/{{ v }}" class="action-link download">Download</a>
                                                            {% else %}
                                                                <span class="action-link download">No Access</span>
                                                            {% endif %}
                                                       
                                       </li>
                                        {%endif%}
                                {%endfor%}
                            {%endfor%}
                    {% endif %}
            
     

                                 
                        </ul>

                </div>

   {% endfor %}
{%endif%}

{% endblock body %}
</body>
<script>
    // 1. VIEW TOGGLE LOGIC
    function setView(viewType) {
        const lists = document.querySelectorAll('.file-list');
        const btnList = document.getElementById('btnList');
        const btnGrid = document.getElementById('btnGrid');

        lists.forEach(list => {
            if (viewType === 'grid') {
                list.classList.add('grid-view');
                btnGrid.classList.add('active');
                btnList.classList.remove('active');
            } else {
                list.classList.remove('grid-view');
                btnList.classList.add('active');
                btnGrid.classList.remove('active');
            }
        });
    }

    // 2. SORTING LOGIC
    function sortItems(criteria) {
        const lists = ['dirList', 'fileList']; // IDs of the ULs

        lists.forEach(listId => {
            const list = document.getElementById(listId);
            const items = Array.from(list.getElementsByClassName('list-item'));

            items.sort((a, b) => {
                if (criteria === 'name') {
                    // Sort by Name (A-Z)
                    const nameA = a.getAttribute('data-name').toLowerCase();
                    const nameB = b.getAttribute('data-name').toLowerCase();
                    return nameA.localeCompare(nameB);
                } else if (criteria === 'date') {
                    // Sort by Date (Newest First) - using data-timestamp
                    const timeA = parseInt(a.getAttribute('data-timestamp'));
                    const timeB = parseInt(b.getAttribute('data-timestamp'));
                    return timeB - timeA;
                }
            });

            // Re-append sorted items
            items.forEach(item => list.appendChild(item));
        });
    }
function openFileDialog() {
    document.getElementById('fileInput').click();
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Show progress container
    const container = document.getElementById('uploadContainer');
    const fill = document.getElementById('progressFill');
    const text = document.getElementById('uploadText');

    container.style.display = 'block';
    fill.style.width = '0%';
    text.innerText = `Uploading... 0%`;

    const currentPath = document.body.dataset.currentPath || '.';

    const formData = new FormData();
    formData.append('file', file);
    formData.append('path', currentPath);

    // XMLHttpRequest to track progress
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/uploadFile', true);

    xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 100);
            fill.style.width = percent + '%';
            text.innerText = `Uploading... ${percent}%`;
        }
    };

    xhr.onload = () => {
        if (xhr.status === 200 || xhr.status === 201) {
            text.innerText = 'Upload successful!';
            fill.style.width = '100%';
            setTimeout(() => {
                container.style.display = 'none';
            }, 1500);
            // Reload page or refresh file list
            location.reload();
        } else {
            text.innerText = 'Upload failed!';
            console.error('Upload error:', xhr.responseText);
        }
    };

    xhr.onerror = () => {
        text.innerText = 'Upload failed!';
        console.error('Upload error');
    };

    xhr.send(formData);

    // Reset file input
    event.target.value = '';
}

</script>

</html>
