<html lang="en">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>stream storage</title>
<link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
</head>
<body data-current-path="{{ path }}">
{% block body %}

<header>
     <h1>üìÇ Stream Storage</h1>
    <button class="btn" onclick="openFileDialog()">Upload File</button>
    <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">
    <div class="toolbar">
        <input id="searchInput" class="btn" placeholder="Search‚Ä¶" oninput="applyFilters()">

            <select id="typeFilter" class="btn" onchange="applyFilters()">
                <option value="">All types</option>
                <option value="image">Images</option>
                <option value="text">Text</option>
                <option value="pdf">PDF</option>
                <option value="video">Video</option>
                <option value="audio">Audio</option>
                <option value="zip">Archives</option>
            </select>

            <select id="sortSelect" class="btn" onchange="sortItems(this.value)">
                <option value="name">Name (A-Z)</option>
                <option value="date">Date Modified</option>
                <option value="size">Size (Large ‚Üí Small)</option>
            </select>
    </div>
</header>

<!-- ‚úÖ Upload Progress Container -->
<div id="uploadContainer" class="upload-container" style="display:none;">
    <div class="upload-box">
        <span id="uploadText">Uploading... 0%</span>
        <div class="progress-bar">
            <div id="progressFill"></div>
        </div>
    </div>
</div>

<div class="drive-container">
        {% for drive in drives %}
            <a href="/dir/{{ drive }}" class="drive-card active" onclick="selectDrive(event, this)">
                <div class="drive-icon">üíø</div>
                <div class="drive-info">
                    <span class="drive-name">Local Disk ({{ drive }})</span>
                    <span class="drive-label">System</span>
                </div>
            </a>
        {% endfor %}
</div>

<nav class="breadcrumbs">
    {% if path %}
        {% set path_=path.split('/') %}
        {% for i in  path_ %}

            <a href='/dir/{{ "/".join(path_[:loop.index]) }}'>{{ path_[:loop.index][loop.index0] }}</a>
            /
        {% endfor %}

    {% endif %}
</nav>

{%if files%}
  {% for key,dict in files.items()%}
    <div class="file-section">
       
                

                {%if key=="dir"%}
                            <h3 class="section-title">{{key.uppercase}}</h3>
                            <ul class="file-list" id="dirList">
                        {% for di in dict %}
                            {% for k,v in di.items() %}
                                {% if k=='path' %}
                                    {% set dir_=v.split('/')[-1:]|join('') %}
                                       <li class="list-item"
                                                data-name="{{ dir_ }}"
                                                data-timestamp="{{ di.get('mtime_ts', 0) }}"
                                                data-type="dir">
                                                        <div class="item-info">
                                                            <div class="item-icon">üìÅ</div>
                                                                <div class="item-details">
                                                                    <span class="item-name">{{ dir_ }}</span>
                                           

                                                                             {% if di.get('time_mod') %}
                                                                                <span class="item-meta">
                                                                                {{ di.get('time_mod') }} ‚Ä¢ {{ di.get('size_h') }}
                                                                                </span>

                                                                             {% endif %}
                                                                             {% if not di.get('listable', di.get('perm', {}).get('r', False)) %}
                                                                                        <span class="item-meta">Access denied</span>
                                                                             {% endif %}
                                                                </div>
                                                        </div>
                                                    {% if di.get('listable', di.get('perm', {}).get('r', False)) %}
                                                        <a href="/dir/{{ v }}" class="action-link">Open</a>
                                                    {% else %}
                                                        <span class="action-link">No Access</span>
                                                    {% endif %}
                                               
                                
                                        </li>
                                         {% endif %}
                            {% endfor %}
                        {% endfor %}

                                        
            </ul>
    </div>

    {% elif key=='files' %}


    <div class="file-section">
    <h3 class="section-title">{{key.uppercase}}</h3>
    <ul class="file-list" id="fileList">
                            {% for dit in dict %}
                                {% for k,v in dit.items() %}
                                    {% if k=='path' %}
                                        {% set file_=v.split('/')[-1:]|join('') %}
                                            <li class="list-item"
                                                data-name="{{ file_ }}"
                                                data-timestamp="{{ dit.get('mtime_ts', 0) }}"
                                                data-size="{{ dit.get('size_b', 0) }}"
                                                data-mime="{{ dit.get('mime', '') }}"
                                                data-ext="{{ dit.get('ext', '') }}"
                                                data-type="file">
                                                 <div class="item-info">
                                                    <div class="item-icon">üìÉ</div>
                                                        <div class="item-details">
                                                            <span class="item-name">{{ file_ }}</span>
                                                        {% if dit.get('time_mod') %}
                                                             <span class="item-meta">
                                                                {{ dit.get('time_mod') }} ‚Ä¢ {{ dit.get('size_h') }}
                                                                </span>

                                                        {%endif%}
                                                        </div>
                                                </div>
                                                            {% if dit.get('perm', {}).get('r', False) %}
                                                                <a href="/file/{{ v }}" class="action-link download">Download</a>
                                                            {% else %}
                                                                <span class="action-link download">No Access</span>
                                                            {% endif %}
                                                       
                                       </li>
                                        {%endif%}
                                {%endfor%}
                            {%endfor%}
                    {% endif %}
            
     

                                 
                        </ul>

                </div>

   {% endfor %}
{%endif%}

{% endblock body %}
</body>
<script>
   function classify(mime, ext) {
  mime = (mime || "").toLowerCase();
  ext = (ext || "").toLowerCase();

  if (mime.startsWith("image/")) return "image";
  if (mime.startsWith("video/")) return "video";
  if (mime.startsWith("audio/")) return "audio";
  if (mime === "application/pdf" || ext === "pdf") return "pdf";
  if (mime.startsWith("text/") || ["txt","md","py","js","html","css","json","csv","log"].includes(ext)) return "text";
  if (["zip","rar","7z","tar","gz"].includes(ext)) return "zip";
  return "other";
}

function applyFilters() {
  const q = (document.getElementById("searchInput").value || "").toLowerCase();
  const type = document.getElementById("typeFilter").value;

  document.querySelectorAll(".list-item").forEach(item => {
    const name = (item.getAttribute("data-name") || "").toLowerCase();
    const mime = item.getAttribute("data-mime") || "";
    const ext = item.getAttribute("data-ext") || "";
    const isDir = item.getAttribute("data-type") === "dir";

    const matchesSearch = !q || name.includes(q);
    const matchesType = !type || isDir || classify(mime, ext) === type;

    item.style.display = (matchesSearch && matchesType) ? "" : "none";
  });
}

function openFileDialog() {
    document.getElementById('fileInput').click();
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Show progress container
    const container = document.getElementById('uploadContainer');
    const fill = document.getElementById('progressFill');
    const text = document.getElementById('uploadText');

    container.style.display = 'block';
    fill.style.width = '0%';
    text.innerText = `Uploading... 0%`;

    const currentPath = document.body.dataset.currentPath || '.';

    const formData = new FormData();
    formData.append('file', file);
    formData.append('path', currentPath);

    // XMLHttpRequest to track progress
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/uploadFile', true);

    xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 100);
            fill.style.width = percent + '%';
            text.innerText = `Uploading... ${percent}%`;
        }
    };

    xhr.onload = () => {
        if (xhr.status === 200 || xhr.status === 201) {
            text.innerText = 'Upload successful!';
            fill.style.width = '100%';
            setTimeout(() => {
                container.style.display = 'none';
            }, 1500);
            // Reload page or refresh file list
            location.reload();
        } else {
            text.innerText = 'Upload failed!';
            console.error('Upload error:', xhr.responseText);
        }
    };

    xhr.onerror = () => {
        text.innerText = 'Upload failed!';
        console.error('Upload error');
    };

    xhr.send(formData);

    // Reset file input
    event.target.value = '';
}

function sortItems(criteria) {
  const lists = ['dirList', 'fileList'];

  lists.forEach(listId => {
    const list = document.getElementById(listId);
    if (!list) return; // ‚úÖ guard

    const items = Array.from(list.getElementsByClassName('list-item'));

    items.sort((a, b) => {
      if (criteria === 'name') {
        const nameA = (a.getAttribute('data-name') || "").toLowerCase();
        const nameB = (b.getAttribute('data-name') || "").toLowerCase();
        return nameA.localeCompare(nameB);
      } else if (criteria === 'date') {
        const timeA = Number(a.getAttribute('data-timestamp')) || 0;
        const timeB = Number(b.getAttribute('data-timestamp')) || 0;
        return timeB - timeA; // newest first
      }
    });

    items.forEach(item => list.appendChild(item));
  });
}

</script>

</html>
